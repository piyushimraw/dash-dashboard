---
phase: 02-mfe-migration
plan: 04
type: execute
wave: 3
depends_on: [02-03]
files_modified:
  - apps/shell/src/routes/_auth.settings.tsx
  - apps/shell/src/routes/_auth.reports.tsx
  - apps/shell/src/routes/_auth.aao.tsx
  - apps/shell/src/routes/_auth.carcontrol.tsx
  - apps/shell/src/routes/_auth.vehicle_exchange.tsx
autonomous: false

must_haves:
  truths:
    - "Shell routes import page components from MFE packages instead of local pages/"
    - "Routes maintain existing role checks and error boundaries"
    - "Build produces separate chunks for each MFE route"
    - "Navigation to settings, reports, aao, carcontrol, vehicle_exchange loads MFE content"
  artifacts:
    - path: "apps/shell/src/routes/_auth.settings.tsx"
      provides: "Settings route importing from @apps/mfe-settings"
      contains: "from '@apps/mfe-settings'"
    - path: "apps/shell/src/routes/_auth.reports.tsx"
      provides: "Reports route importing from @apps/mfe-reports"
      contains: "from '@apps/mfe-reports'"
    - path: "apps/shell/src/routes/_auth.aao.tsx"
      provides: "AAO route importing from @apps/mfe-aao"
      contains: "from '@apps/mfe-aao'"
    - path: "apps/shell/src/routes/_auth.carcontrol.tsx"
      provides: "Car Control route importing from @apps/mfe-car-control"
      contains: "from '@apps/mfe-car-control'"
    - path: "apps/shell/src/routes/_auth.vehicle_exchange.tsx"
      provides: "Vehicle Exchange route importing from @apps/mfe-vehicle-exchange"
      contains: "from '@apps/mfe-vehicle-exchange'"
  key_links:
    - from: "apps/shell/src/routes/_auth.*.tsx"
      to: "apps/mfe-*/src/index.ts"
      via: "workspace package imports"
      pattern: "from '@apps/mfe-"
---

<objective>
Update five shell routes to import page components from MFE packages instead of local pages/ directory.

Purpose: Wire the simple MFE packages created in 02-03 into the shell routing. TanStack Router's autoCodeSplitting will automatically create separate chunks for each route.

Output: Five routes load content from MFE packages, build produces separate chunks
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-mfe-migration/02-RESEARCH.md

# Prior plan summary (MFE packages created)
@.planning/phases/02-mfe-migration/02-03-SUMMARY.md

# Shell routes to update
@apps/shell/src/routes/_auth.settings.tsx
@apps/shell/src/routes/_auth.reports.tsx
@apps/shell/src/routes/_auth.aao.tsx
@apps/shell/src/routes/_auth.carcontrol.tsx
@apps/shell/src/routes/_auth.vehicle_exchange.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update settings and reports routes to use MFE imports</name>
  <files>
    apps/shell/src/routes/_auth.settings.tsx
    apps/shell/src/routes/_auth.reports.tsx
  </files>
  <action>
Update route files to import from MFE packages:

**_auth.settings.tsx:**
```typescript
import { requireRole } from '@/auth/requireRole'
import { MfeErrorBoundary } from '@/components/MfeErrorBoundary'
import { ROLES } from '@/config/roles'
import { SettingsPage } from '@apps/mfe-settings'  // Changed from @/pages/SettingPage
import { createFileRoute } from '@tanstack/react-router'

export const Route = createFileRoute('/_auth/settings')({
  beforeLoad: () =>
    requireRole([ROLES.SUPER_ADMIN, ROLES.SYSTEM_ADMIN]),
  component: RouteComponent,
})

function RouteComponent() {
  return (
    <MfeErrorBoundary mfeName="Settings">
      <SettingsPage />
    </MfeErrorBoundary>
  )
}
```

**_auth.reports.tsx:**
```typescript
import { requireRole } from '@/auth/requireRole'
import { MfeErrorBoundary } from '@/components/MfeErrorBoundary'
import { ROLES } from '@/config/roles'
import { ReportsPage } from '@apps/mfe-reports'  // Changed from @/pages/ReportsPage
import { createFileRoute } from '@tanstack/react-router'

export const Route = createFileRoute('/_auth/reports')({
  beforeLoad: () =>
    requireRole([ROLES.SUPER_ADMIN, ROLES.SYSTEM_ADMIN, ROLES.FLEET_MANAGER]),
  component: RouteComponent,
})

function RouteComponent() {
  return (
    <MfeErrorBoundary mfeName="Reports">
      <ReportsPage />
    </MfeErrorBoundary>
  )
}
```

Keep existing role checks from the original files. Check each file for its specific roles.
  </action>
  <verify>
Files updated with @apps/mfe-* imports
  </verify>
  <done>Settings and reports routes updated to use MFE imports</done>
</task>

<task type="auto">
  <name>Task 2: Update aao, carcontrol, vehicle_exchange routes</name>
  <files>
    apps/shell/src/routes/_auth.aao.tsx
    apps/shell/src/routes/_auth.carcontrol.tsx
    apps/shell/src/routes/_auth.vehicle_exchange.tsx
  </files>
  <action>
Update remaining route files:

**_auth.aao.tsx:**
- Change `import AaoPage from '@/pages/AaoPage'` to `import { AaoPage } from '@apps/mfe-aao'`
- Keep existing route config, role checks, and MfeErrorBoundary wrapper

**_auth.carcontrol.tsx:**
- Change `import CarControl from '@/pages/CarControl'` to `import { CarControlPage } from '@apps/mfe-car-control'`
- Update component usage from `<CarControl />` to `<CarControlPage />`
- Keep existing route config, role checks, and MfeErrorBoundary wrapper

**_auth.vehicle_exchange.tsx:**
- Change `import VehicleExchangePage from '@/pages/VehicleExchangePage'` to `import { VehicleExchangePage } from '@apps/mfe-vehicle-exchange'`
- Keep existing route config, role checks, and MfeErrorBoundary wrapper

Preserve all existing role checks from each file - check beforeLoad for specific roles.
  </action>
  <verify>
Files updated with @apps/mfe-* imports
  </verify>
  <done>AAO, car control, and vehicle exchange routes updated</done>
</task>

<task type="auto">
  <name>Task 3: Verify build produces MFE chunks</name>
  <files>
    apps/shell/vite.config.ts
  </files>
  <action>
Run `pnpm --filter @apps/shell build` and verify:
- Build completes successfully
- Check dist/assets/ for route chunk files

No changes needed to vite.config.ts - autoCodeSplitting is already enabled.
  </action>
  <verify>
`pnpm --filter @apps/shell build` succeeds
  </verify>
  <done>Build produces separate chunks for MFE routes</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Five shell routes updated to import from MFE packages. Build produces separate chunks for each route.
  </what-built>
  <how-to-verify>
1. Start dev server: `pnpm --filter @apps/shell dev`

2. Navigate to each route and verify MFE content loads:
   - /settings - placeholder text renders
   - /reports - placeholder text renders
   - /aao - placeholder text renders
   - /carcontrol - placeholder text renders
   - /vehicle_exchange - placeholder text renders

3. Open browser Network tab and verify:
   - Navigating to each route loads a separate JS chunk
   - Initial page load does NOT include all MFE chunks upfront

4. Check MfeErrorBoundary shows MFE name if triggered (can test by temporarily throwing error in MFE)
  </how-to-verify>
  <resume-signal>Type "approved" if all 5 routes work correctly with lazy loading, or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `pnpm --filter @apps/shell build` passes
2. `ls apps/shell/dist/assets/` shows separate chunk files for routes
3. Human verified: dev server navigation works for all 5 routes
4. Human verified: browser network tab shows separate chunk loading per route
</verification>

<success_criteria>
- All 5 routes import page components from @apps/mfe-* packages
- Build produces separate chunks for each MFE route
- Dev server serves MFE content correctly (human verified)
- Role checks and error boundaries preserved
</success_criteria>

<output>
After completion, create `.planning/phases/02-mfe-migration/02-04-SUMMARY.md`
</output>
