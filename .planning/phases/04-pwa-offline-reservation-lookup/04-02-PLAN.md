---
phase: 04-pwa-offline-reservation-lookup
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - apps/shell/src/lib/queryPersister.ts
  - packages/api-client/src/queryClient.ts
  - apps/shell/src/main.tsx
autonomous: true

must_haves:
  truths:
    - "React Query cache persists to IndexedDB across page reloads"
    - "Queries fire when offline, allowing SW to serve cached responses"
    - "Previously loaded reservation data displays after page refresh (offline)"
  artifacts:
    - path: "apps/shell/src/lib/queryPersister.ts"
      provides: "IndexedDB persister factory function"
      exports: ["createIDBPersister"]
    - path: "packages/api-client/src/queryClient.ts"
      provides: "QueryClient with offlineFirst networkMode"
      contains: "networkMode"
    - path: "apps/shell/src/main.tsx"
      provides: "PersistQueryClientProvider wrapping app"
      contains: "PersistQueryClientProvider"
  key_links:
    - from: "apps/shell/src/main.tsx"
      to: "apps/shell/src/lib/queryPersister.ts"
      via: "import createIDBPersister"
      pattern: "createIDBPersister"
    - from: "apps/shell/src/main.tsx"
      to: "@tanstack/react-query-persist-client"
      via: "PersistQueryClientProvider import"
      pattern: "PersistQueryClientProvider"
---

<objective>
Implement React Query cache persistence to IndexedDB for offline data access.

Purpose: Allow users to view previously loaded reservation data when offline by persisting the React Query cache to IndexedDB and configuring queries to work in offline-first mode.

Output: IndexedDB persister, updated QueryClient with offline support, and PersistQueryClientProvider integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-pwa-offline-reservation-lookup/04-RESEARCH.md
@.planning/phases/04-pwa-offline-reservation-lookup/04-01-SUMMARY.md

@apps/shell/src/main.tsx
@packages/api-client/src/queryClient.ts
@packages/api-client/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create IndexedDB persister for React Query</name>
  <files>apps/shell/src/lib/queryPersister.ts</files>
  <action>
Create `apps/shell/src/lib/queryPersister.ts` that exports a factory function for creating IndexedDB persisters:

```typescript
import { get, set, del } from 'idb-keyval';
import type { PersistedClient, Persister } from '@tanstack/react-query-persist-client';

/**
 * Creates an IndexedDB-backed persister for React Query cache.
 * Uses idb-keyval for async, promise-based IndexedDB access.
 *
 * @param idbValidKey - The key used to store the cache in IndexedDB (default: 'hertz-query-cache')
 * @returns Persister object compatible with PersistQueryClientProvider
 */
export function createIDBPersister(idbValidKey: IDBValidKey = 'hertz-query-cache'): Persister {
  return {
    persistClient: async (client: PersistedClient) => {
      await set(idbValidKey, client);
    },
    restoreClient: async () => {
      return await get<PersistedClient>(idbValidKey);
    },
    removeClient: async () => {
      await del(idbValidKey);
    },
  };
}
```

Key points:
- Use `idb-keyval` for simple key-value IndexedDB operations (async, non-blocking)
- Default cache key is 'hertz-query-cache' for easy identification in DevTools
- Type the return as `Persister` from the persist-client package
- Add JSDoc comments explaining the function purpose
  </action>
  <verify>
Run `pnpm -F @apps/shell tsc --noEmit` to verify TypeScript compiles without errors.
  </verify>
  <done>
queryPersister.ts exists with createIDBPersister function that returns a properly typed Persister object.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update QueryClient with offline-first configuration</name>
  <files>packages/api-client/src/queryClient.ts</files>
  <action>
Update `packages/api-client/src/queryClient.ts` to configure React Query for offline support:

1. Add `networkMode: 'offlineFirst'` to default query options:
   - This allows queries to fire even when offline
   - Service worker can intercept and serve cached responses
   - Without this, React Query pauses queries when offline

2. Add `gcTime` (garbage collection time):
   - Set to `24 * 60 * 60 * 1000` (24 hours in milliseconds)
   - Must be >= the persister maxAge to prevent data loss
   - This is the React Query v5 replacement for `cacheTime`

3. Keep existing options:
   - `retry: 1`
   - `staleTime: 5 * 60 * 1000` (5 minutes)
   - `refetchOnWindowFocus: false`

4. Add `refetchOnReconnect: true` to fetch fresh data when coming back online

The updated defaultOptions should look like:
```typescript
defaultOptions: {
  queries: {
    networkMode: 'offlineFirst',
    retry: 1,
    staleTime: 5 * 60 * 1000, // 5 min
    gcTime: 24 * 60 * 60 * 1000, // 24 hours - must be >= persister maxAge
    refetchOnWindowFocus: false,
    refetchOnReconnect: true,
  },
  mutations: {
    retry: 0,
  },
},
```
  </action>
  <verify>
Run `pnpm -F @packages/api-client build` to verify TypeScript compiles. Check the output in `packages/api-client/dist/queryClient.d.ts` exports correctly.
  </verify>
  <done>
queryClient.ts has networkMode: 'offlineFirst', gcTime: 24 hours, and refetchOnReconnect: true configured.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate PersistQueryClientProvider in main.tsx</name>
  <files>apps/shell/src/main.tsx</files>
  <action>
Update `apps/shell/src/main.tsx` to use PersistQueryClientProvider instead of QueryClientProvider:

1. Add imports:
   ```typescript
   import { PersistQueryClientProvider } from '@tanstack/react-query-persist-client';
   import { createIDBPersister } from './lib/queryPersister';
   ```

2. Remove the QueryClientProvider import (replaced by PersistQueryClientProvider)

3. Create the persister instance outside the component:
   ```typescript
   const persister = createIDBPersister();
   ```

4. Replace `<QueryClientProvider client={queryClient}>` with:
   ```tsx
   <PersistQueryClientProvider
     client={queryClient}
     persistOptions={{
       persister,
       maxAge: 24 * 60 * 60 * 1000, // 24 hours - matches queryClient gcTime
       dehydrateOptions: {
         shouldDehydrateQuery: (query) => {
           // Only persist successful queries with data
           return query.state.status === 'success' && query.state.data !== undefined;
         },
       },
     }}
   >
   ```

5. Keep the rest of the file unchanged (AppRouter, GlobalDialog, etc.)

Key configuration:
- `maxAge: 24 hours` matches the gcTime in queryClient to prevent data eviction timing issues
- `shouldDehydrateQuery` only persists successful queries with data (not loading/error states)
- The persister is created once outside the component to avoid recreating on each render
  </action>
  <verify>
Run `pnpm -F @apps/shell dev` and check browser DevTools:
1. Application > IndexedDB should show 'hertz-query-cache' entry after loading reservation data
2. Network tab should show API request
3. Console should have no errors
  </verify>
  <done>
main.tsx uses PersistQueryClientProvider with IndexedDB persister, 24h maxAge, and proper dehydration options.
  </done>
</task>

</tasks>

<verification>
1. Run `pnpm build` from root - all packages should build successfully
2. Run `pnpm -F @apps/shell dev`
3. Navigate to Reservation Lookup page to trigger API fetch
4. Open DevTools > Application > IndexedDB > look for 'hertz-query-cache' database
5. Refresh the page - data should load from persisted cache (check Network tab shows no API request if data is fresh)
6. Use DevTools > Network > Offline mode, refresh page - reservation data should still display
</verification>

<success_criteria>
- queryPersister.ts exports createIDBPersister function
- queryClient.ts has networkMode: 'offlineFirst' and gcTime: 24 hours
- main.tsx uses PersistQueryClientProvider with persister
- IndexedDB shows cached query data after visiting Reservation Lookup
- Page refresh loads data from IndexedDB cache
</success_criteria>

<output>
After completion, create `.planning/phases/04-pwa-offline-reservation-lookup/04-02-SUMMARY.md`
</output>
