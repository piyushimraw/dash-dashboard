---
phase: 02-mfe-migration
plan: 06
type: execute
wave: 3
depends_on: [02-01]
files_modified:
  - apps/mfe-rent/package.json
  - apps/mfe-rent/tsconfig.json
  - apps/mfe-rent/src/index.ts
  - apps/mfe-rent/src/RentPage.tsx
  - apps/mfe-rent/src/forms/RentVehicleForm.tsx
  - apps/mfe-rent/src/forms/rent.schema.ts
  - apps/mfe-rent/src/forms/rent.types.ts
  - apps/shell/tsconfig.json
  - apps/shell/package.json
  - apps/shell/src/routes/_auth.rent.tsx
autonomous: true

must_haves:
  truths:
    - "Rent MFE package exists in apps/mfe-rent/"
    - "RentVehicleForm uses @packages/ui form components (FormProvider, FormInput, FormSelect)"
    - "Form validation works with Zod schema"
    - "Shell rent route imports from @apps/mfe-rent"
    - "Form success emits event bus 'data:refresh' event for cross-MFE communication"
  artifacts:
    - path: "apps/mfe-rent/src/index.ts"
      provides: "RentPage export"
      exports: ["RentPage"]
    - path: "apps/mfe-rent/src/RentPage.tsx"
      provides: "Rent page layout with form"
      min_lines: 20
    - path: "apps/mfe-rent/src/forms/RentVehicleForm.tsx"
      provides: "Rent vehicle form with validation and event bus emission"
      min_lines: 50
  key_links:
    - from: "apps/mfe-rent/src/forms/RentVehicleForm.tsx"
      to: "@packages/ui"
      via: "form component imports"
      pattern: "from '@packages/ui'"
    - from: "apps/mfe-rent/src/forms/RentVehicleForm.tsx"
      to: "@packages/event-bus"
      via: "event emission on form success"
      pattern: "from '@packages/event-bus'"
    - from: "apps/shell/src/routes/_auth.rent.tsx"
      to: "apps/mfe-rent/src/index.ts"
      via: "workspace package import"
      pattern: "from '@apps/mfe-rent'"
---

<objective>
Create mfe-rent package with RentVehicleForm using @packages/ui form components and event bus for cross-MFE communication.

Purpose: Rent MFE demonstrates form integration with shared form components extracted in 02-01. The form includes validation with Zod and uses FormProvider, FormInput, FormSelect from @packages/ui. On successful form submission, it emits a 'data:refresh' event via the event bus to notify other MFEs (like dashboard) to refresh their data.

Output: Rent MFE with working form validation using shared components and event bus integration
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-mfe-migration/02-RESEARCH.md

# Prior plan - form components extracted
@.planning/phases/02-mfe-migration/02-01-SUMMARY.md

# Source files
@apps/shell/src/pages/RentPage.tsx
@apps/shell/src/forms/rent/RentVehicleForm.tsx
@apps/shell/src/forms/rent/rent.schema.ts
@apps/shell/src/forms/rent/rent.types.ts

# Event bus for cross-MFE communication
@packages/event-bus/src/index.ts
@packages/event-bus/src/events.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create mfe-rent package structure</name>
  <files>
    apps/mfe-rent/package.json
    apps/mfe-rent/tsconfig.json
    apps/mfe-rent/src/index.ts
  </files>
  <action>
Create mfe-rent package:

1. **apps/mfe-rent/package.json**:
```json
{
  "name": "@apps/mfe-rent",
  "version": "0.0.1",
  "private": true,
  "type": "module",
  "main": "./src/index.ts",
  "types": "./src/index.ts",
  "exports": {
    ".": {
      "types": "./src/index.ts",
      "import": "./src/index.ts"
    }
  },
  "dependencies": {
    "@packages/ui": "workspace:*",
    "@packages/event-bus": "workspace:*",
    "@packages/mfe-types": "workspace:*"
  },
  "peerDependencies": {
    "react": "^19.0.0",
    "react-dom": "^19.0.0",
    "react-hook-form": "^7.71.0",
    "@hookform/resolvers": "^5.2.0",
    "zod": "^4.0.0",
    "lucide-react": "^0.562.0"
  }
}
```

2. **apps/mfe-rent/tsconfig.json**:
```json
{
  "extends": "../../tsconfig.base.json",
  "compilerOptions": {
    "composite": true,
    "outDir": "./dist",
    "rootDir": "./src",
    "declaration": true,
    "declarationMap": true,
    "noEmit": false
  },
  "references": [
    { "path": "../../packages/ui" },
    { "path": "../../packages/event-bus" },
    { "path": "../../packages/mfe-types" }
  ],
  "include": ["src"]
}
```

3. **apps/mfe-rent/src/index.ts**:
```typescript
export { RentPage } from "./RentPage";
export type { RentVehicleFormValues } from "./forms/rent.types";
```
  </action>
  <verify>
Directory apps/mfe-rent/ created with package.json, tsconfig.json, src/index.ts
  </verify>
  <done>mfe-rent package structure created</done>
</task>

<task type="auto">
  <name>Task 2: Migrate rent page and form files with event bus integration</name>
  <files>
    apps/mfe-rent/src/RentPage.tsx
    apps/mfe-rent/src/forms/RentVehicleForm.tsx
    apps/mfe-rent/src/forms/rent.schema.ts
    apps/mfe-rent/src/forms/rent.types.ts
  </files>
  <action>
Copy and update rent files:

1. **apps/mfe-rent/src/forms/rent.schema.ts** - Copy from shell as-is (no shell-specific imports)

2. **apps/mfe-rent/src/forms/rent.types.ts** - Copy from shell as-is

3. **apps/mfe-rent/src/forms/RentVehicleForm.tsx** - Copy and update imports, add event bus:
```typescript
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { Car, Calendar, User, MapPin } from "lucide-react";

import { FormProvider, FormInput, FormSelect, Button } from "@packages/ui";
import { eventBus } from "@packages/event-bus";

import { rentVehicleSchema } from "./rent.schema";
import type { RentVehicleFormValues } from "./rent.types";

export function RentVehicleForm() {
  const form = useForm<RentVehicleFormValues>({
    resolver: zodResolver(rentVehicleSchema),
    // ... existing defaultValues
  });

  const onSubmit = (data: RentVehicleFormValues) => {
    console.log("Rent form submitted:", data);
    // TODO: API call here

    // Emit event for cross-MFE communication
    // Other MFEs (e.g., dashboard) can subscribe to refresh their data
    eventBus.emit("data:refresh", { source: "mfe-rent", action: "rent-created" });
  };

  // ... rest of existing implementation unchanged
}
```

Convert default export to named export.

4. **apps/mfe-rent/src/RentPage.tsx** - Copy and update:
```typescript
import { RentVehicleForm } from "./forms/RentVehicleForm";
import { Car } from "lucide-react";

export function RentPage() {
  // ... existing JSX unchanged
}
```

Convert default export to named export.
  </action>
  <verify>
Files exist at apps/mfe-rent/src/*.tsx and apps/mfe-rent/src/forms/*.ts
  </verify>
  <done>Rent page and form migrated with @packages/ui imports and event bus integration</done>
</task>

<task type="auto">
  <name>Task 3: Wire rent MFE to shell</name>
  <files>
    apps/shell/tsconfig.json
    apps/shell/package.json
    apps/shell/src/routes/_auth.rent.tsx
  </files>
  <action>
1. Update `apps/shell/tsconfig.json` to add mfe-rent reference:
Add to references array: `{ "path": "../mfe-rent" }`

2. Update `apps/shell/package.json` to add dependency:
Add to dependencies: `"@apps/mfe-rent": "workspace:*"`

3. Update `apps/shell/src/routes/_auth.rent.tsx`:
```typescript
import { requireRole } from '@/auth/requireRole'
import { MfeErrorBoundary } from '@/components/MfeErrorBoundary'
import { ROLES } from '@/config/roles'
import { RentPage } from '@apps/mfe-rent'  // Changed from @/pages/RentPage
import { createFileRoute } from '@tanstack/react-router'

export const Route = createFileRoute('/_auth/rent')({
  beforeLoad: () =>
    requireRole([
      ROLES.SUPER_ADMIN,
      ROLES.COUNTER_AGENT
    ]),
  component: RouteComponent,
})

function RouteComponent() {
  return (
    <MfeErrorBoundary mfeName="Rent">
      <RentPage />
    </MfeErrorBoundary>
  )
}
```

4. Run `pnpm install && pnpm --filter @apps/shell build`
  </action>
  <verify>
`pnpm install && pnpm --filter @apps/shell build` succeeds
  </verify>
  <done>Rent MFE wired to shell, build passes</done>
</task>

</tasks>

<verification>
1. `pnpm --filter @apps/shell build` passes
2. `pnpm --filter @apps/shell dev` - navigate to /rent
3. Form renders with all fields
4. Enter invalid data - validation errors appear
5. Fill valid data - form submits (check console log for both form data and event bus emission)
6. Verify console shows: "Rent form submitted:" and event bus emission log
</verification>

<success_criteria>
- mfe-rent package exists with RentPage and RentVehicleForm
- Form imports FormProvider, FormInput, FormSelect from @packages/ui
- Form imports eventBus from @packages/event-bus
- Form emits 'data:refresh' event on successful submission
- Zod validation works correctly
- Shell rent route imports from @apps/mfe-rent
- Build passes, form renders and validates
</success_criteria>

<output>
After completion, create `.planning/phases/02-mfe-migration/02-06-SUMMARY.md`
</output>
