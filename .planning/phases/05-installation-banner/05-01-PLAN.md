---
phase: 05-installation-banner
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/shell/src/hooks/usePWAInstall.ts
  - apps/shell/src/components/PWAInstallBanner.tsx
  - apps/shell/src/index.css
autonomous: false

must_haves:
  truths:
    - "App detects when PWA installation is available via beforeinstallprompt event"
    - "Installation banner displays prominently when install is available"
    - "Banner includes install button that triggers native installation prompt"
    - "Banner can be dismissed and respects user's dismissal preference (session-scoped)"
    - "Banner does not appear if app is already installed (standalone mode)"
    - "Installation success tracked and banner hidden after successful install"
  artifacts:
    - path: "apps/shell/src/hooks/usePWAInstall.ts"
      provides: "Install prompt state management with useSyncExternalStore"
      contains: "useSyncExternalStore"
    - path: "apps/shell/src/components/PWAInstallBanner.tsx"
      provides: "Styled banner with brand colors and app icon"
      contains: "bg-primary"
    - path: "apps/shell/src/index.css"
      provides: "slideUp animation keyframes"
      contains: "@keyframes slideUp"
  key_links:
    - from: "apps/shell/src/components/PWAInstallBanner.tsx"
      to: "apps/shell/src/hooks/usePWAInstall.ts"
      via: "usePWAInstall hook import"
      pattern: "usePWAInstall"
    - from: "apps/shell/src/routes/__root.tsx"
      to: "apps/shell/src/components/PWAInstallBanner.tsx"
      via: "PWAInstallBanner component render"
      pattern: "<PWAInstallBanner"
---

<objective>
Refactor existing PWA install banner to match requirements: use useSyncExternalStore pattern (consistent with useNetworkState), sessionStorage for dismissal (not localStorage), add slide-up animation, update styling with brand colors and app icon preview, and add standalone mode detection.

Purpose: Encourage PWA installation with a polished, brand-consistent banner that respects user preferences and browser state.
Output: Updated hook and component that match established codebase patterns and CONTEXT.md requirements.
</objective>

<execution_context>
@~/.claude/agents/gsd-executor.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-installation-banner/05-CONTEXT.md
@.planning/phases/05-installation-banner/05-RESEARCH.md

# Existing files to modify
@apps/shell/src/hooks/usePWAInstall.ts
@apps/shell/src/hooks/useNetworkState.ts
@apps/shell/src/components/PWAInstallBanner.tsx
@apps/shell/src/index.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor usePWAInstall hook to use useSyncExternalStore</name>
  <files>apps/shell/src/hooks/usePWAInstall.ts</files>
  <action>
Rewrite the hook to match the useNetworkState pattern:

1. Use `useSyncExternalStore` instead of useState/useEffect for event subscription
2. Store deferredPrompt in module-scope variable (like existing pattern)
3. Create subscribe function that:
   - Listens to `beforeinstallprompt` event
   - Calls `e.preventDefault()` to capture the event
   - Stores event reference and calls callback
   - Also listens to `appinstalled` event to clear state
4. Create getSnapshot function returning install availability state
5. Create getServerSnapshot returning false (no install on server)

6. Add standalone mode detection:
   - Check `window.matchMedia('(display-mode: standalone)').matches`
   - Check iOS `navigator.standalone` property
   - Return this synchronously to prevent flash

7. Change dismissal from localStorage to sessionStorage:
   - Use `sessionStorage.getItem/setItem` instead of localStorage
   - Key remains 'pwa-install-dismissed'
   - Track dismissal in React state initialized from sessionStorage

8. Return object with:
   - `canInstall`: boolean from useSyncExternalStore
   - `isStandalone`: boolean for standalone mode
   - `isDismissed`: boolean for dismissal state
   - `promptInstall`: async function that calls prompt() and returns outcome
   - `dismiss`: function that sets sessionStorage and state
   - `showBanner`: computed (canInstall && !isStandalone && !isDismissed)

Keep BeforeInstallPromptEvent interface and WindowEventMap declaration.
Clear sessionStorage dismissal key when install is accepted.
  </action>
  <verify>
TypeScript compiles: `pnpm -F @apps/shell exec tsc --noEmit`
  </verify>
  <done>
Hook uses useSyncExternalStore pattern, sessionStorage for dismissal, includes standalone detection, and exports showBanner computed property.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add animation and update InstallBanner styling</name>
  <files>apps/shell/src/index.css, apps/shell/src/components/PWAInstallBanner.tsx</files>
  <action>
Part A - Add slideUp animation to index.css:

Add after existing @keyframes shimmer block:
```css
@keyframes slideUp {
  from {
    transform: translate3d(0, 100%, 0);
    opacity: 0;
  }
  to {
    transform: translate3d(0, 0, 0);
    opacity: 1;
  }
}

.animate-slideUp {
  animation: slideUp 0.3s ease-out;
}
```

Part B - Update PWAInstallBanner.tsx:

1. Update hook usage:
   - Use `showBanner` instead of `showPrompt`
   - Use `promptInstall` instead of `install`
   - Keep `dismiss` as is

2. Update container div:
   - Add animation class: `animate-slideUp`
   - Change from `bg-background border-t border-border` to brand colors:
     `bg-primary text-primary-foreground`
   - Keep `fixed bottom-0 left-0 right-0 z-50 shadow-lg`
   - Add `py-4` for slightly more padding

3. Update icon section:
   - Replace Download icon div with app icon preview
   - Use inline SVG (Hertz logo placeholder) or a simple app icon
   - Size: `w-10 h-10` with rounded corners
   - Use brand-yellow background with dark icon

4. Update text:
   - Main text: "Install app" (not "Install Hertz" per CONTEXT.md)
   - Subtext: "Works offline - Faster access"
   - Text colors should contrast with primary background

5. Update Install button:
   - Change to `bg-primary-foreground text-primary` (inverted)
   - Keep "Install" text
   - Add `font-semibold`

6. Update dismiss button:
   - Use lucide X icon (already imported)
   - `text-primary-foreground hover:bg-primary-foreground/10`
   - Keep aria-label="Dismiss install prompt"

7. Add role="dialog" and aria-label="Install application prompt" to container
  </action>
  <verify>
Build succeeds: `pnpm build`
Banner appears at bottom with slide-up animation, brand colors visible.
  </verify>
  <done>
CSS has slideUp keyframes, banner uses brand colors (bg-primary), has animation class, shows "Install app" text with benefit subtext.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify installation flow in browser</name>
  <what-built>
    - Refactored usePWAInstall hook with useSyncExternalStore pattern
    - Updated PWAInstallBanner with brand styling and slide-up animation
    - Session-scoped dismissal (clears on browser close)
    - Standalone mode detection (hides banner if already installed)
  </what-built>
  <how-to-verify>
    Testing requires a Chromium browser (Chrome, Edge). Safari/Firefox do not support beforeinstallprompt.

    1. Start dev server: `pnpm dev` (from apps/shell or root)
    2. Open Chrome at http://localhost:5173
    3. Open DevTools > Application > Manifest (verify manifest loads)

    Test banner appearance:
    4. If banner doesn't appear immediately, check:
       - DevTools > Application > Service Workers (SW should be registered)
       - Site may need HTTPS for install prompt - try Incognito mode
       - Chrome may require "installable" criteria: valid manifest + SW
    5. Banner should slide up from bottom with brand colors (yellow/gold primary)
    6. Banner should show "Install app" with "Works offline - Faster access" subtext

    Test dismissal:
    7. Click X button to dismiss banner
    8. Refresh page - banner should NOT reappear (sessionStorage)
    9. Close browser completely and reopen - banner SHOULD reappear (session cleared)

    Test install flow:
    10. Click "Install" button
    11. Native Chrome install dialog should appear
    12. If accepted, banner should disappear
    13. If dismissed, banner remains visible

    Test standalone mode:
    14. If app was installed, open from desktop/home screen
    15. Banner should NOT appear (standalone mode detected)

    Note: If beforeinstallprompt doesn't fire (common in dev), verify:
    - Hook doesn't error (check console)
    - Banner conditionally renders based on showBanner
    - Production build may be needed for full PWA testing
  </how-to-verify>
  <resume-signal>Type "approved" if install flow works, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
- TypeScript compiles without errors
- Build succeeds with no warnings
- Hook matches useNetworkState pattern (useSyncExternalStore)
- sessionStorage used for dismissal (not localStorage)
- Banner has brand colors and slide-up animation
- Standalone mode detection prevents banner in installed PWA
</verification>

<success_criteria>
1. App detects when PWA installation is available via beforeinstallprompt event
2. Installation banner displays prominently with brand colors when install is available
3. Banner slides up with animation on appearance
4. Banner includes install button that triggers native installation prompt
5. Banner can be dismissed (X button) and respects session-scoped preference
6. Banner does not appear if app is already installed (standalone mode)
7. Installation success clears dismissal and hides banner
8. Human verification confirms flow works on supported browsers
</success_criteria>

<output>
After completion, create `.planning/phases/05-installation-banner/05-01-SUMMARY.md`
</output>
