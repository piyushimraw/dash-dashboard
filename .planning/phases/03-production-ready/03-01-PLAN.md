---
phase: 03-production-ready
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/shell/vite.config.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Build produces separate vendor chunks for React, Radix UI, and TanStack libraries"
    - "Bundle analyzer shows vendor dependencies are not duplicated across MFE chunks"
    - "Build warns or fails when chunks exceed 150 kB limit"
    - "Initial page load downloads only shell + first route chunk (not all vendor code)"
  artifacts:
    - path: "apps/shell/vite.config.ts"
      provides: "manualChunks configuration for vendor splitting"
      contains: "manualChunks"
    - path: "apps/shell/dist/assets/vendor-react-*.js"
      provides: "Deduplicated React bundle"
    - path: "apps/shell/dist/assets/vendor-radix-*.js"
      provides: "Deduplicated Radix UI bundle"
    - path: "apps/shell/dist/assets/vendor-tanstack-*.js"
      provides: "Deduplicated TanStack bundle"
  key_links:
    - from: "apps/shell/vite.config.ts"
      to: "rollup output.manualChunks"
      via: "build.rollupOptions.output.manualChunks function"
      pattern: "manualChunks.*node_modules"
---

<objective>
Configure Vite build optimization with manualChunks for granular vendor splitting

Purpose: Optimize caching efficiency by separating stable vendor code from frequently-changing application code. Create separate chunks for React, Radix UI, and TanStack libraries so browser cache remains valid when only application code changes.

Output: Updated vite.config.ts with manualChunks, rollup-plugin-visualizer for analysis, and chunk size limits
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-production-ready/03-RESEARCH.md

Current build output shows:
- index-*.js: 482.50 kB (contains ALL vendor dependencies)
- Route chunks: 0.5-81 kB each (already code-split by TanStack Router)

Target: Split vendor dependencies into stable, cacheable chunks
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure manualChunks for vendor splitting</name>
  <files>apps/shell/vite.config.ts</files>
  <action>
Add rollup-plugin-visualizer and configure manualChunks in vite.config.ts:

1. Install dependencies (at workspace root):
   - `pnpm add -D rollup-plugin-visualizer`

2. Update vite.config.ts to add:
   - Import visualizer from rollup-plugin-visualizer
   - Add visualizer plugin with options: { open: false, filename: 'dist/stats.html', gzipSize: true, brotliSize: true }
   - Add build.rollupOptions.output.manualChunks as a function that:
     - Extracts node_modules packages into named vendor chunks
     - Groups @radix-ui/* into 'vendor-radix'
     - Groups react and react-dom into 'vendor-react'
     - Groups @tanstack/* into 'vendor-tanstack'
     - Groups zustand into 'vendor-zustand'
     - Groups remaining node_modules into 'vendor-other'
   - Set build.chunkSizeWarningLimit to 150 (kB)

3. The manualChunks function pattern:
```typescript
manualChunks: (id) => {
  if (id.includes('node_modules')) {
    const parts = id.split('node_modules/')[1].split('/');
    const packageName = parts[0].startsWith('@')
      ? `${parts[0]}/${parts[1]}`
      : parts[0];

    if (packageName.startsWith('@radix-ui')) return 'vendor-radix';
    if (packageName === 'react' || packageName === 'react-dom') return 'vendor-react';
    if (packageName.startsWith('@tanstack')) return 'vendor-tanstack';
    if (packageName === 'zustand') return 'vendor-zustand';
    return 'vendor-other';
  }
}
```

IMPORTANT: Do NOT return a chunk name for application code - let TanStack Router handle route splitting.
  </action>
  <verify>
Run `pnpm build` and verify output shows:
- vendor-react-*.js (should be ~130-150 kB)
- vendor-radix-*.js (should be ~100-150 kB)
- vendor-tanstack-*.js (should be ~150-200 kB)
- vendor-zustand-*.js (should be ~5-10 kB)
- vendor-other-*.js (remaining deps)
- Route chunks still present (_auth.dashboard-*.js, etc.)
- dist/stats.html exists for analysis
  </verify>
  <done>Build produces separate vendor chunks with no duplication across MFE route chunks</done>
</task>

<task type="auto">
  <name>Task 2: Verify chunk structure and cache efficiency</name>
  <files>apps/shell/dist/</files>
  <action>
Run build and analyze the output:

1. Run `pnpm build` to generate production build
2. List all JS files in dist/assets/ with sizes
3. Open dist/stats.html to verify:
   - No duplicate React/Radix/TanStack code in route chunks
   - Vendor chunks contain expected libraries
   - Route chunks only contain application code

4. Verify initial load strategy:
   - index.html references index-*.js (shell entry)
   - Vendor chunks are loaded as dependencies
   - Route chunks are loaded on navigation (lazy)

If bundle analyzer shows duplication or unexpected chunk contents, adjust manualChunks configuration.
  </action>
  <verify>
- Total vendor chunk size combined should be ~400-500 kB (similar to original index.js)
- Route chunks should be small (<100 kB each)
- No warnings about chunk size exceeding 150 kB limit (except vendor-other which may be larger)
  </verify>
  <done>Bundle analysis confirms proper vendor splitting with no duplication</done>
</task>

</tasks>

<verification>
After completing both tasks:

1. Build succeeds: `pnpm build` exits 0
2. Vendor chunks exist:
   - `ls apps/shell/dist/assets/vendor-*.js` shows 4-5 vendor chunks
3. Route chunks preserved:
   - `ls apps/shell/dist/assets/_auth*.js` shows MFE route chunks
4. Bundle analysis available:
   - `apps/shell/dist/stats.html` exists and can be opened in browser
5. No duplication:
   - Opening stats.html shows React appears only in vendor-react chunk
   - Radix components appear only in vendor-radix chunk
</verification>

<success_criteria>
- Build produces vendor-react, vendor-radix, vendor-tanstack, vendor-zustand chunks
- Route chunks (_auth.dashboard, _auth.rent, etc.) contain only application code
- Bundle analyzer (stats.html) confirms no vendor duplication
- Chunk size warnings only for intentionally large chunks (vendor-other)
- Initial page load would only fetch shell + active route + shared vendors (not all routes)
</success_criteria>

<output>
After completion, create `.planning/phases/03-production-ready/03-01-SUMMARY.md`
</output>
