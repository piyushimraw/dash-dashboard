---
phase: 04-pwa-offline-reservation-lookup
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - apps/shell/src/hooks/useNetworkState.ts
  - packages/ui/src/components/OfflineIndicator.tsx
  - packages/ui/src/index.ts
  - apps/shell/src/components/layout/header.tsx
autonomous: false

must_haves:
  truths:
    - "User sees offline indicator banner when viewing cached data offline"
    - "Offline indicator disappears when network connection restored"
    - "Reservation Lookup displays cached data when offline"
    - "Full offline workflow verified by human"
  artifacts:
    - path: "apps/shell/src/hooks/useNetworkState.ts"
      provides: "Hook for detecting online/offline status"
      exports: ["useNetworkState"]
    - path: "packages/ui/src/components/OfflineIndicator.tsx"
      provides: "Offline status banner component"
      exports: ["OfflineIndicator"]
  key_links:
    - from: "apps/shell/src/components/layout/header.tsx"
      to: "packages/ui/src/components/OfflineIndicator.tsx"
      via: "component import"
      pattern: "OfflineIndicator"
    - from: "packages/ui/src/components/OfflineIndicator.tsx"
      to: "apps/shell/src/hooks/useNetworkState.ts"
      via: "hook import"
      pattern: "useNetworkState"
---

<objective>
Create offline UX components and verify end-to-end offline functionality.

Purpose: Provide clear visual feedback when users are viewing cached data offline, and verify the complete offline experience works as expected for the Reservation Lookup module.

Output: Network state hook, offline indicator component, header integration, and verified offline functionality.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-pwa-offline-reservation-lookup/04-RESEARCH.md
@.planning/phases/04-pwa-offline-reservation-lookup/04-01-SUMMARY.md
@.planning/phases/04-pwa-offline-reservation-lookup/04-02-SUMMARY.md

@apps/shell/src/hooks/useIsDesktop.ts
@apps/shell/src/components/layout/header.tsx
@packages/ui/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useNetworkState hook</name>
  <files>apps/shell/src/hooks/useNetworkState.ts</files>
  <action>
Create `apps/shell/src/hooks/useNetworkState.ts` that tracks online/offline status:

```typescript
import { useState, useEffect, useSyncExternalStore } from 'react';

/**
 * Subscribes to browser online/offline events.
 * Uses useSyncExternalStore for React 18+ concurrent mode compatibility.
 */
function subscribe(callback: () => void) {
  window.addEventListener('online', callback);
  window.addEventListener('offline', callback);
  return () => {
    window.removeEventListener('online', callback);
    window.removeEventListener('offline', callback);
  };
}

function getSnapshot() {
  return navigator.onLine;
}

function getServerSnapshot() {
  // On server, assume online
  return true;
}

/**
 * Hook that returns current network connectivity status.
 * Updates reactively when browser goes online/offline.
 *
 * Note: navigator.onLine can have false positives (connected to network
 * but no internet). For more accurate detection, combine with React Query's
 * fetchStatus === 'paused'.
 *
 * @returns boolean - true if online, false if offline
 */
export function useNetworkState(): boolean {
  return useSyncExternalStore(subscribe, getSnapshot, getServerSnapshot);
}
```

Key points:
- Use `useSyncExternalStore` (React 18+) for proper concurrent mode support
- This is the recommended pattern for subscribing to external browser APIs
- Provide server snapshot for SSR compatibility (always true on server)
- Add JSDoc noting navigator.onLine limitations (mentioned in research)
  </action>
  <verify>
Run `pnpm -F @apps/shell tsc --noEmit` to verify TypeScript compiles without errors.
  </verify>
  <done>
useNetworkState.ts exists and exports a hook that tracks online/offline status using useSyncExternalStore.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create OfflineIndicator component</name>
  <files>packages/ui/src/components/OfflineIndicator.tsx, packages/ui/src/index.ts</files>
  <action>
Create `packages/ui/src/components/OfflineIndicator.tsx`:

```typescript
import * as React from 'react';

interface OfflineIndicatorProps {
  /** Whether the app is currently online */
  isOnline: boolean;
  /** Optional className for styling overrides */
  className?: string;
}

/**
 * Banner component that displays when the user is offline.
 * Shows a yellow warning bar indicating cached data is being shown.
 *
 * @example
 * const isOnline = useNetworkState();
 * <OfflineIndicator isOnline={isOnline} />
 */
export function OfflineIndicator({ isOnline, className = '' }: OfflineIndicatorProps) {
  if (isOnline) {
    return null;
  }

  return (
    <div
      role="alert"
      aria-live="polite"
      className={`bg-amber-100 border-b border-amber-300 px-4 py-2 text-center text-sm text-amber-800 ${className}`}
    >
      <span className="inline-flex items-center gap-2">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
          aria-hidden="true"
        >
          <line x1="1" y1="1" x2="23" y2="23" />
          <path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55" />
          <path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39" />
          <path d="M10.71 5.05A16 16 0 0 1 22.58 9" />
          <path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88" />
          <path d="M8.53 16.11a6 6 0 0 1 6.95 0" />
          <line x1="12" y1="20" x2="12.01" y2="20" />
        </svg>
        You&apos;re offline. Showing cached data.
      </span>
    </div>
  );
}
```

Then update `packages/ui/src/index.ts` to export the new component:
- Add: `export { OfflineIndicator } from './components/OfflineIndicator';`

Key points:
- Component receives `isOnline` as prop (keeps it decoupled from specific hook)
- Uses role="alert" and aria-live="polite" for accessibility
- Amber/yellow color scheme matches Hertz brand and warning context
- Inline SVG for wifi-off icon (no external dependencies)
- Returns null when online (no DOM footprint)
  </action>
  <verify>
Run `pnpm -F @packages/ui build` to verify TypeScript compiles and exports correctly. Check `packages/ui/dist/index.d.ts` includes OfflineIndicator export.
  </verify>
  <done>
OfflineIndicator.tsx exists with accessible offline banner, and packages/ui exports it.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate OfflineIndicator in shell header</name>
  <files>apps/shell/src/components/layout/header.tsx</files>
  <action>
Update `apps/shell/src/components/layout/header.tsx` to show the offline indicator:

1. Add imports:
   ```typescript
   import { OfflineIndicator } from '@packages/ui';
   import { useNetworkState } from '@/hooks/useNetworkState';
   ```

2. Inside the Header component, add the hook:
   ```typescript
   const isOnline = useNetworkState();
   ```

3. Add OfflineIndicator at the TOP of the header component's return, BEFORE the existing header content:
   ```tsx
   return (
     <>
       <OfflineIndicator isOnline={isOnline} />
       <header className="...existing classes...">
         {/* existing header content */}
       </header>
     </>
   );
   ```

The indicator should appear as a fixed banner above the header when offline, not inside the header's flexbox layout.

If the header uses a fragment already or different structure, ensure OfflineIndicator renders first in the visual order.
  </action>
  <verify>
Run `pnpm -F @apps/shell dev`, open browser, use DevTools > Network > Offline checkbox to simulate offline. Verify yellow banner appears above header.
  </verify>
  <done>
Header component renders OfflineIndicator that shows when network is offline.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete PWA offline support for Reservation Lookup module:
1. Service worker with API response caching (NetworkFirst strategy)
2. React Query cache persistence to IndexedDB
3. Offline-first query configuration
4. Visual offline indicator in header
5. Offline fallback page for uncached routes
  </what-built>
  <how-to-verify>
**Test Offline Functionality:**

1. **Start the dev server:**
   ```bash
   cd /Users/piyshriv3/projects/new-dash-ui
   pnpm -F @apps/shell dev
   ```

2. **Initial load (online):**
   - Open http://localhost:5173 in browser
   - Log in if required
   - Navigate to Reservation Lookup page
   - Verify table loads with reservation data
   - Check DevTools > Application > IndexedDB > see 'hertz-query-cache' entry

3. **Test offline mode:**
   - Open DevTools > Network tab
   - Check "Offline" checkbox to simulate offline
   - **Expected:** Yellow banner appears: "You're offline. Showing cached data."
   - Refresh the page (Cmd+R / F5)
   - **Expected:** Reservation data still displays (from cache)
   - **Expected:** No network errors in console

4. **Test reconnection:**
   - Uncheck "Offline" in Network tab
   - **Expected:** Yellow banner disappears immediately
   - Data may refetch in background (refetchOnReconnect: true)

5. **Test offline fallback page:**
   - Go offline again (check Offline in Network tab)
   - Navigate to a route you haven't visited (e.g., a deep link)
   - If the route isn't cached, **Expected:** offline.html fallback page displays

6. **Test persistence across sessions:**
   - Go back online
   - Visit Reservation Lookup, load data
   - Close browser completely
   - Reopen browser, navigate directly to Reservation Lookup
   - **Expected:** Data loads from IndexedDB cache (fast, no network delay)

**What to report:**
- Does the offline indicator appear/disappear correctly?
- Does reservation data persist and display when offline?
- Does the offline fallback page render for uncached routes?
- Any console errors or unexpected behavior?
  </how-to-verify>
  <resume-signal>
Type "approved" if all offline functionality works correctly, or describe any issues found.
  </resume-signal>
</task>

</tasks>

<verification>
1. All TypeScript compiles: `pnpm build` from root
2. Offline indicator visible when network offline
3. Reservation data persists in IndexedDB
4. Data displays when refreshing page offline
5. Offline fallback page works for uncached routes
6. Human verification confirms end-to-end offline experience
</verification>

<success_criteria>
- useNetworkState hook tracks online/offline status
- OfflineIndicator component displays amber banner when offline
- Header shows offline indicator appropriately
- Human verifies complete offline workflow functions correctly
- Reservation Lookup displays cached data when offline
</success_criteria>

<output>
After completion, create `.planning/phases/04-pwa-offline-reservation-lookup/04-03-SUMMARY.md`
</output>
