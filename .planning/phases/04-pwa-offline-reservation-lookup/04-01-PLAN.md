---
phase: 04-pwa-offline-reservation-lookup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/shell/package.json
  - packages/api-client/package.json
  - apps/shell/vite.config.ts
  - apps/shell/public/offline.html
autonomous: true

must_haves:
  truths:
    - "Service worker caches API responses from dummyjson.com"
    - "Static assets are precached during SW installation"
    - "Offline fallback page displays when navigating to uncached routes offline"
  artifacts:
    - path: "apps/shell/vite.config.ts"
      provides: "Workbox runtime caching configuration for reservation API"
      contains: "runtimeCaching"
    - path: "apps/shell/public/offline.html"
      provides: "Offline fallback page"
      min_lines: 20
  key_links:
    - from: "apps/shell/vite.config.ts"
      to: "https://dummyjson.com"
      via: "urlPattern in runtimeCaching"
      pattern: "dummyjson\\.com"
---

<objective>
Configure service worker for API caching and offline asset delivery.

Purpose: Enable the service worker to cache reservation API responses at runtime, allowing users to view previously loaded data when offline.

Output: Updated vite.config.ts with workbox runtimeCaching, new offline.html fallback page, and dependencies installed.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-pwa-offline-reservation-lookup/04-RESEARCH.md

@apps/shell/vite.config.ts
@apps/shell/package.json
@packages/api-client/package.json
@apps/mfe-reservation-lookup/src/features/rent-vehicle/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install PWA persistence dependencies</name>
  <files>apps/shell/package.json, packages/api-client/package.json, pnpm-lock.yaml</files>
  <action>
Install the required dependencies for React Query persistence and IndexedDB:

```bash
cd /Users/piyshriv3/projects/new-dash-ui
pnpm add -F @packages/api-client @tanstack/react-query-persist-client
pnpm add -F @apps/shell idb-keyval
```

The `@tanstack/react-query-persist-client` package provides `PersistQueryClientProvider` and persistence utilities.
The `idb-keyval` package provides a lightweight IndexedDB key-value wrapper for cache storage.

Install at api-client level for persist-client (used in queryClient setup) and shell level for idb-keyval (used in main.tsx).
  </action>
  <verify>
Run `pnpm list @tanstack/react-query-persist-client -r` and `pnpm list idb-keyval -r` to confirm packages are installed in correct workspaces.
  </verify>
  <done>
Dependencies @tanstack/react-query-persist-client and idb-keyval are installed and visible in respective package.json files.
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure Workbox runtime caching for reservation API</name>
  <files>apps/shell/vite.config.ts</files>
  <action>
Update the VitePWA plugin configuration in vite.config.ts to add:

1. **workbox.runtimeCaching** array with a NetworkFirst strategy for the dummyjson.com API:
   - urlPattern: `/^https:\/\/dummyjson\.com\/.*$/i`
   - handler: 'NetworkFirst'
   - cacheName: 'reservations-api'
   - expiration: maxEntries 50, maxAgeSeconds 86400 (24 hours)
   - cacheableResponse: statuses [0, 200]
   - networkTimeoutSeconds: 10 (fall back to cache after 10s)

2. **workbox.globPatterns**: Add patterns for precaching static assets:
   - `'**/*.{js,css,html,svg,png,woff2}'`

3. **workbox.cleanupOutdatedCaches**: true
4. **workbox.skipWaiting**: true
5. **workbox.clientsClaim**: true
6. **workbox.navigateFallback**: '/offline.html'
7. **workbox.navigateFallbackDenylist**: [/^\/api\//]

Add these workbox options inside the existing VitePWA configuration object.
  </action>
  <verify>
Run `pnpm -F @apps/shell build` and check that `dist/sw.js` is generated with workbox runtime caching code. Search the generated SW for "dummyjson" to confirm the runtime caching pattern is included.
  </verify>
  <done>
vite.config.ts contains workbox configuration with runtimeCaching for dummyjson.com API and proper caching strategies.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create offline fallback page</name>
  <files>apps/shell/public/offline.html</files>
  <action>
Create `apps/shell/public/offline.html` with a user-friendly offline message:

1. Create the `public/` directory in apps/shell if it doesn't exist
2. Create offline.html with:
   - DOCTYPE, html lang="en"
   - Meta charset UTF-8, viewport
   - Title: "Offline - Hertz Dashboard"
   - Inline CSS for styling (no external dependencies):
     - body: font-family system-ui, text-align center, padding 50px, background #f9fafb
     - .container: max-width 400px, margin 0 auto
     - h1: color #1f2937, margin-bottom 16px
     - p: color #6b7280, margin-bottom 24px
     - button: background #fbbf24 (Hertz yellow), color #1f2937, padding 12px 24px, border none, border-radius 8px, font-size 16px, cursor pointer
   - Content:
     - Icon: WiFi-off icon using inline SVG (24x24, stroke currentColor)
     - Heading: "You're Offline"
     - Paragraph: "The page you're trying to access isn't available offline. Previously viewed reservations are still accessible."
     - Button: "Go Back" with onclick="window.history.back()"
     - Second paragraph: "Connect to the internet to access all features."

Do NOT use emojis - use inline SVG for the icon instead.
  </action>
  <verify>
Confirm file exists at `apps/shell/public/offline.html` and contains valid HTML. Open in browser to visually verify layout.
  </verify>
  <done>
offline.html exists in public/ directory with styled offline message and Go Back button.
  </done>
</task>

</tasks>

<verification>
1. Run `pnpm -F @apps/shell build` - should complete without errors
2. Check `apps/shell/dist/sw.js` contains "dummyjson" pattern
3. Check `apps/shell/dist/offline.html` exists
4. Run `pnpm -F @apps/shell preview` and verify SW registers in browser DevTools > Application > Service Workers
</verification>

<success_criteria>
- Dependencies installed in correct packages
- vite.config.ts has workbox runtimeCaching for dummyjson.com API
- offline.html exists and displays properly when opened directly
- Production build generates sw.js with runtime caching configuration
</success_criteria>

<output>
After completion, create `.planning/phases/04-pwa-offline-reservation-lookup/04-01-SUMMARY.md`
</output>
